# RingSectorMesh — 개념적 흐름

## 개요
Unity 컴포넌트로서 링 형태의 부채꼴(annular sector)을 절차적으로 생성하여 런타임과 에디터에서 렌더링합니다. 이 컴포넌트는 메시, 버텍스 컬러, 머티리얼 속성 등 시각 표시에 집중하며 물리/충돌 처리는 별도의 시스템에 위임합니다.

## 핵심 목적
- 각도, 반지름, 두께, 테셀레이션 같은 파라미터로 제어되는 링-섹터 기하학을 표현합니다.
- 선택적으로 셀 단위 피해/침식 시각화를 `RingSectorDamageMask`를 통해 제공합니다.
- 메시를 불필요하게 다시 생성하지 않고 셰이더(반지름 오프셋)와 셀 글로우 펄스 같은 경량 런타임 제어를 노출합니다.

## 주요 책임
- 기하 파라미터 또는 피해 마스크에 따라 메시 토폴로지를 생성합니다.
- 피해와 글로우 상태를 반영하도록 버텍스 색을 유지·갱신합니다.
- `MaterialPropertyBlock`을 통해 머티리얼 생성 및 렌더러별 속성을 관리합니다.
- 필요한 경우에만 토폴로지를 리빌드하고, 자주 변하는 값은 셰이더 속성으로 처리해 CPU를 절감합니다.

## 설계 원칙
- 역할 분리: 렌더링/시각화만 담당하고 충돌/게임 로직은 외부에서 처리합니다.
- 동작 모드 유연성: 마스크가 없으면 단순 섹터 모드, 있으면 그리드(셀) 모드로 동작합니다.
- 렌더 파이프라인 독립성: URP와 Built-in 셰이더를 폴백 체인으로 지원합니다.
- 에디터 친화성: `[ExecuteAlways]`와 `OnValidate`로 즉시 피드백 제공.

## 데이터 및 제어 흐름(개념적)
1. 초기화
   - `MeshFilter`와 `MeshRenderer` 참조 획득
   - 동적 `Mesh` 생성 및(옵션) 언릿 머티리얼 생성
   - 파라미터(각도, 반지름, segments) 또는 마스크 셀 수에 따라 초기 토폴로지 빌드
   - 초기 렌더러 속성(base alpha, radius offset) 설정

2. 프레임별 업데이트
   - 기하 파라미터나 마스크 셀 수가 변경되었는지(해시 비교) 확인하고, 변경 시 메시 토폴로지 리빌드
   - 피해 마스크가 있는 경우 글로우 타이머나 침식 변화를 반영하기 위해 매 프레임 버텍스 색 갱신
   - 필요 시 `MaterialPropertyBlock`(반지름 오프셋, 렌더러별 알파) 갱신

3. 피해 및 비주얼 이펙트
   - 피해 마스크는 셀 단위 침식 값과 그리드 크기를 제공합니다.
   - `RingSectorMesh`는 셀별 글로우 만료 시각 배열을 유지하며, `vertexColor`와 `glowColor`를 `glowDuration` 동안 보간합니다.
   - 침식 값이 1.0 이상인 셀은 메시 토폴로지에서 제외되어 구멍처럼 보이며, 부분 침식은 버텍스 색을 어둡게 합니다.

## 상태 관리
- 토폴로지(드물게 변경): 파라미터 및 마스크 셀 수로 제어되며 계산된 해시로 추적합니다. 해시가 다르거나 강제 리빌드가 요청되면 메시를 리빌드합니다.
- 시각 상태(빈번한 갱신): 글로우 타이머와 침식 값이 버텍스 색 갱신을 유발하지만 토폴로지 리빌드를 트리거하지 않습니다.
- 빠른 동적 변경(예: 스크롤): `radiusOffset`은 `MaterialPropertyBlock`으로 적용하여 메시 재생성을 피합니다.

## 메시 생성 전략(개념적)
- 단순 섹터 모드
  - 호를 (segments + 1) 샘플 점으로 나눕니다.
  - 각 샘플 점에 대해 inner/outer 정점을 생성하고 UV.x에 호 진행도, UV.y에 반지름 진행도를 할당합니다.
  - 인접 샘플 점 사이에 쿼드를 만들고 삼각형으로 변환합니다. 와인딩은 필요 시 뒤집을 수 있습니다.

- 피해 마스크 모드
  - 섹터를 각도 분할(segments) × 반지름 분할(radialCells) 그리드로 처리합니다.
  - 각 반지름 단계마다 정점 행을, 각 각도 단계마다 정점 열을 생성합니다 (vertexCols = segments + 1).
  - 각 그리드 셀에 대해 침식 값을 조회하고 완전히 침식된 셀은 삼각형 생성을 건너뜁니다.
  - UV는 (angleProgress, radialProgress)를 인코딩해 버텍스가 셀 인덱스로 역산될 수 있게 합니다.

## 시각 매핑(개념적)
- 버텍스 컬러가 셀 단위 시각 상태의 주요 수단입니다.
  - 기본 버텍스 알파는 낮게 설정되어(예: 50) 메시가 가시적이지만 억제된 상태로 유지됩니다.
  - 글로우 펄스는 색을 `glowColor` 쪽으로 증가시키고 알파를 최대값으로 올리며, `glowDuration` 동안 페이드됩니다.
  - 침식은 글로우가 없을 때 RGB를 어둡게 하여 피해 진행을 표시합니다.

- 머티리얼 색과 알파
  - 공유 머티얼은 기본 색을 가지며 투명 설정(URP 또는 Built-in)을 지원합니다. `MaterialPropertyBlock`은 렌더러별 알파와 `radiusOffset`을 머티리얼 복제 없이 적용합니다.

## 최적화 패턴
- 해시 기반 더티 체크: 기하 관련 입력이 변경될 때만 메시를 리빌드합니다.
- 업데이트 빈도 분리: 토폴로지 리빌드는 드물게, 버텍스 색과 MPB 갱신은 자주 수행합니다.
- `Mesh.MarkDynamic()`을 사용해 Unity에 잦은 업데이트를 힌트합니다.
- 가능한 배열을 재사용하여 할당을 줄이고, 마스크가 연결될 때만 글로우 타이머 배열을 생성합니다.

## 통합 지점(개념적)
- `RingSectorDamageMask`: 그리드 차원과 셀별 침식값을 제공하며 `RingSectorMesh.SetDamageMask()`로 등록됩니다.
- 외부 시스템은 `PulseCellGlow(angleIndex, radialIndex)`를 호출해 특정 셀의 글로우를 트리거할 수 있습니다.
- `SectorSpawner` 같은 관리자는 여러 메시의 `RadiusOffset`을 설정하여 동기화된 스크롤/오프셋 효과를 만들 수 있습니다.

## 디버깅 및 일반 문제(개념적)
- 메시가 보이지 않는 경우: `flipWinding` 또는 `forceDoubleSided`를 전환해 컬링/와인딩 문제를 확인하세요.
- 성능 문제: `segments` 수나 마스크 해상도를 낮추고 잦은 강제 리빌드를 피하세요.
- 렌더 파이프라인 간 시각 차이: 셰이더 프로퍼티 폴백과 커스텀 셰이더에서 `_RadiusOffset` 구현을 확인하세요. MPB 업데이트가 보이지 않을 수 있습니다.

## 확장성(개념적)
- 매우 고해상도 마스크의 경우 침식 계산을 GPU(컴퓨트 셰이더)로 이전할 수 있습니다.
- LOD를 추가해 거리별로 `segments`를 줄이거나 방사선 셀을 병합할 수 있습니다.
- 셰이더를 확장해 UV를 이용한 엣지 글로우, 노이즈, 림 셰이딩 등을 구현하면 CPU 변경 없이 비주얼을 강화할 수 있습니다.

## 요약
RingSectorMesh는 비용이 큰 토폴로지 생성과 빈번한 시각 업데이트를 분리하여 설계되었습니다. 셰이더와 `MaterialPropertyBlock`을 통해 렌더러별 경량 변경을 처리하고, 버텍스 컬러로 셀 단위 세밀한 시각을 표현하여 성능과 유연성을 동시에 확보합니다。

---
참고: 이 파일은 `Docs/RingSectorMesh_ConceptualFlow.md`에 저장되어 팀 레퍼런스로 사용됩니다.